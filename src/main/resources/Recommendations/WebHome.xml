<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>Recommendations</web>
  <name>WebHome</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>Main.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1430924288000</creationDate>
  <date>1432556652000</date>
  <contentUpdateDate>1432554559000</contentUpdateDate>
  <version>1.1</version>
  <title>WebHome</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{groovy}}
import groovy.json.*

def recConfigDoc = xwiki.getDocument('RecommendationsCode.RecEngineConfig');
def easyrecAddress = recConfigDoc.get('easyrecServerAddress');
def easyrecApiKey = recConfigDoc.get('easyrecApiKey');
def easyrecTenantId = recConfigDoc.get('easyrecTenantId');
def jsonSlurper = new JsonSlurper();

if(easyrecAddress.isEmpty() || easyrecApiKey.isEmpty() || easyrecTenantId.isEmpty()) {
  println "You have to set up an easyrec server in order to use this extension";
}
else {
  def recommendationType = 1;
  if(request.get('type')) {
    recommendationType = (request.get('type')).toInteger();
  }
  def queryURL = "";
  def recommendations2 = [];
  /* 
  Type 1 : recommendations for user
  Type 2 : other users also viewed ...
  Type 3 : related items | edited_together ...
  Type 4 : related items | profile (content-based) ...
  */
  if(recommendationType == 2 &amp;&amp; request.get('doc')) {
    docName = request.get('doc');
    queryURL = easyrecAddress+'api/1.0/json/otherusersalsoviewed?apikey='+easyrecApiKey+'&amp;tenantid='+easyrecTenantId+'&amp;itemid='+docName;
  }
  else if(recommendationType == 3) {
    docName = request.get('doc');
    queryURL = easyrecAddress+'api/1.0/json/relateditems?assoctype=EDITED_TOGETHER&amp;apikey='+easyrecApiKey+'&amp;tenantid='+easyrecTenantId+'&amp;itemid='+docName;
  }
  else if(recommendationType == 4) {
    docName = request.get('doc');
    queryURL = easyrecAddress+'api/1.0/json/relateditems?assoctype=PROFILE_SIMILARITY&amp;apikey='+easyrecApiKey+'&amp;tenantid='+easyrecTenantId+'&amp;itemid='+docName;
  }
  else {
    queryURL = easyrecAddress+'api/1.0/json/recommendationsforuser?actiontype=VIEW&amp;apikey='+easyrecApiKey+'&amp;tenantid='+easyrecTenantId+'&amp;userid='+xcontext.getUser()+'&amp;numberOfResults=100';
    queryURL2 = easyrecAddress+'api/1.0/json/recommendationsforuser?actiontype=EDIT&amp;apikey='+easyrecApiKey+'&amp;tenantid='+easyrecTenantId+'&amp;userid='+xcontext.getUser()+'&amp;numberOfResults=100';
  }

  def userRec = xwiki.getURLContent(queryURL);
  def userRecObject = jsonSlurper.parseText(userRec);
  def recommendations = ""
  if(userRecObject.recommendeditems == null) { // easyrec v0.99 (beta)
    recommendations = userRecObject.recommendedItems; 
  }
  else { // easyrec v0.98 and older
    recommendations = userRecObject.recommendeditems.item; 
  }

  if(!(recommendationType in [2, 3, 4])) {
    def userRec2 = xwiki.getURLContent(queryURL2);
    def userRecObject2 = jsonSlurper.parseText(userRec2);
    if(userRecObject2.recommendeditems == null) {
      recommendations2 = userRecObject2.recommendedItems; 
    }
    else {
      recommendations2 = userRecObject2.recommendeditems.item; 
    }
    recommendations.remove(recommendations2);
    recommendations.addAll(recommendations2);
    Collections.shuffle(recommendations);
  }
  if(userRecObject.recommendeditems != null || userRecObject.recommendedItems != null) {

    def displayHidden = 1;
    if(!xcontext.userReference || xwiki.getDocument(xcontext.getUser()).getObject('XWiki.XWikiUsers').getProperty('displayHiddenDocuments') == null || xwiki.getDocument(xcontext.getUser()).getObject('XWiki.XWikiUsers').getProperty('displayHiddenDocuments').value == 0) {
      displayHidden = 0;
    }

    if(recommendations instanceof Collection) { // Allow the use of .each() method if there are several recommendations
      def i = 1;
      recommendations.each() {
        def pageRecName = xwiki.getDocument(it.id);
        // Display 5 personalized recommendations
        if(pageRecName &amp;&amp; !pageRecName.isNew() &amp;&amp; (!pageRecName.isHidden() || displayHidden == 1) &amp;&amp; xwiki.hasAccessLevel("view", xcontext.getUser(), it.id) &amp;&amp; i&lt;=5) {
          println "[[${it.id}]]"
          i++;
        }
      };
    }
    else {
      def pageRecName = xwiki.getDocument(recommendations.id);
      if(pageRecName &amp;&amp; !pageRecName.isNew() &amp;&amp; (!pageRecName.isHidden() || displayHidden == 1) &amp;&amp; xwiki.hasAccessLevel("view", xcontext.getUser(), recommendations.id)) {
        println "[[${recommendations.id}]]";
      }
    }
  }
  else if(userRecObject.error != null &amp;&amp; !userRecObject.error.isEmpty()) {
    println "//Your recommendation engine configuration is not working!//"
  }
  else {
    println "//No recommendation for you//"
  }
}
{{/groovy}}</content>
</xwikidoc>
